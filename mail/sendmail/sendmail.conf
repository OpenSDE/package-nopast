# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../sendmail/sendmail.conf
# Copyright (C) 2012 The OpenSDE Project
# Copyright (C) 2004 - 2006 The T2 SDE Project
# Copyright (C) 1998 - 2003 Clifford Wolf
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

sm_appenddef() {
	printf "APPENDDEF(\`${1}\', \`${2}\')\n" >> ../devtools/Site/site.config.m4
}

sm_main() {
	#
	# Copy configs
	#
	echo "Copy sendmail config files ..."
	cd $confdir
	rm -rf $root/etc/mail; mkdir -p $root/etc/mail
	cp Makefile aliases local-host-names $root/etc/mail/
	ln -sf mail/sendmail.cf $root/etc/sendmail.cf
	echo "Copy sendmail cf files ..."
	cd $builddir/$xsrcdir/cf; cp -r * /etc/mail
	cp cf/generic-linux.mc /etc/mail/sendmail.mc

	#
	# Compile and install
	#
	cp $confdir/site.config.m4 ../devtools/Site/

	# IPv6 support by default
	sm_appenddef "confENVDEF" "-DNETINET6=1"

	# SASL2 (smtp authentication)
	if pkginstalled -f cyrus-sasl2; then
		sm_appenddef "confENVDEF" "-DSASL=2"
		sm_appenddef "confLIBS" "-lsasl2"
		sm_appenddef "confLIBDIR" "-L$( pkgprefix -r libdir cyrus-sasl2 )"
		sm_appenddef "confINCDIR" "-L$( pkgprefix -r includedir cyrus-sasl2 )"
	fi

	# STARTTLS (smtp + tls/ssl)
	if pkginstalled -f openssl; then
		sm_appenddef "confENVDEF" "-DSTARTTLS"
		sm_appenddef "confLIBS" "-lssl -lcrypto"
		sm_appenddef "confLIBDIR" "-L$( pkgprefix -r libdir openssl )"
		sm_appenddef "confINCDIR" "-L$( pkgprefix -r includedir openssl )"
	fi

	cd ..; ./Build; ./Build install
	install_setmailer sendmail
}

custmain="sm_main"

