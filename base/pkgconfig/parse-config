# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../pkgconfig/parse-config
# Copyright (C) 2006 - 2012 The OpenSDE Project
# Copyright (C) 2006 The T2 SDE Project
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

if atstage cross; then
	#export PKG_CONFIG_DEBUG_SPEW=yes
	export PKG_CONFIG_SYSROOT_DIR="$base/build/$SDECFG_ID"
	export PKG_CONFIG_PATH=$(ls -1d \
		"$PKG_CONFIG_SYSROOT_DIR"/{,usr,usr/X11*,usr/local,opt/*}/{lib,lib64,share}/pkgconfig/ \
		2> /dev/null | tr '\n' ':' | sed -e 's|/\+:|:|g' -e 's|/\+|/|g' -e 's|:$||')

	export PKG_CONFIG_LIBDIR="$PKG_CONFIG_PATH" # needed, otherwse system is used

	# as we use PKG_CONFIG_SYSROOT_DIR, make sure $root doesn't leak on .pc files
	#
	pkgconfig_postflist_sanitize() {
		local pc=
		grep '\.pc$' "$builddir/flist.txt" | while read pc; do
			if grep -q "$root" "$root/$pc"; then
				echo_warning "pkgconfig: fixed $pc."
				sed -i -e "s|$root||g" "$root/$pc"
			fi
		done
	}

	hook_add postflist 1 'pkgconfig_postflist_sanitize'
fi

if ! atstage toolchain; then
	case "$pkg" in
		fhs) hook_add postmake 9 'mkdir -p $root/usr/{lib,share}/pkgconfig' ;;
	esac
fi
