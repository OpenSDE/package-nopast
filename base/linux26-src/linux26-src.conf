# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# Filename: package/.../linux26-src/linux26-src.conf
# Copyright (C) 2007 The OpenSDE Project
# Copyright (C) 1998 - 2003 Clifford Wolf
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

# include the function to patch and configure the kernel
. $base/package/base/linux26/lx_config.sh

main_lx_src() {
	cd $root/usr/src

	echo "Extracting the Linux Kernel Sources [$vanilla_ver] ... "
	lx_tempdir=`mktemp -d tmp.XXXXXXXXXX`

	# hack to extract the files into our usr/src dir ...
	# this part is continued inside lx_injectextraversion
	ln -sf $PWD/${lx_tempdir} $builddir/linux-${vanilla_ver}
	tar -k $taropt $archdir/$srctar -C $builddir/
	chown -R 0:0 ${lx_tempdir} ; chmod go=u,go-w ${lx_tempdir}

	echo "Copying kernel patches ... "
	rm -rf linux$treever-patches ; mkdir -p linux$treever-patches
	cp -v $base/package/$repository/linux$treever/README linux$treever-patches/
	cp -v $patchfiles linux$treever-patches/

	cd ${lx_tempdir}

	lx_config
	# remove debug configs 
	rm -f .config.[1-9] 

	if [ "$ROCKCFG_PKG_LINUX_CONFIG_STYLE" = none ] ; then
		# create a valid .config (new settings may be available etc.)
		yes '' | eval $MAKE oldconfig > /dev/null
	else
		cp -v .config_nomods  ../linux$treever-patches/config_nomods.txt
		cp -v .config_modules ../linux$treever-patches/config_modules.txt
	fi

	# can fail in stage 0-1 ...
	if [ $stagelevel -gt 1 ] && [[ $treever = 24* ]] ; then
		echo "Creating dependencies (e.g. for versioned symbols) ..."
		eval $MAKE dep-files
	fi

	echo "Clean up the *.orig and *~ files ... "
	find -name '*.orig' -o -name '*~' | xargs rm -f
	rm -f .config.old
}

autoextract=0 ; createdocs=0

custmain="main_lx_src"
patchfiles="`echo $base/package/$repository/linux$treever/*.patch` $patchfiles"

