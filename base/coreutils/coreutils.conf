# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../coreutils/coreutils.conf
# Copyright (C) 2006 - 2012 The OpenSDE Project
# Copyright (C) 2004 - 2006 The T2 SDE Project
# Copyright (C) 1998 - 2003 Clifford Wolf
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

if atstage cross; then
	# http://bugs.gentoo.org/show_bug.cgi?id=269256
	var_append configcache ' ' 'gl_cv_func_re_compile_pattern_working=yes'
	var_append configcache ' ' 'gl_cv_func_rename_trailing_dest_slash_bug=no'
	var_append configcache ' ' 'gl_cv_func_rename_trailing_slash_bug=no'

	# cannot be tested while cross-compiling
	var_append configcache ' ' 'gl_cv_func_fstatat_zero_flag=yes'
fi

# apply the patches defined in the coreutils.desc
for x in $(match_source_file -p patch); do
	var_append patchfiles ' ' "$x"
done

# install libstdbuf.so into /usr/lib/coreutils instead of /usr/libexec/coreutils
var_append extraconfopt ' ' "--libexecdir=$libdir"

# without injecting coreutils won't build
var_append GCC_WRAPPER_INSERT ' ' '-std=gnu99'

# Move programs to the locations specified by the FHS
var_append INSTALL_WRAPPER_FILTER "|" \
	"sed -e 's,usr/bin/\
\(cat\|chgrp\|chmod\|chown\|cp\|date\|dd\|df\|echo\
\|false\|hostname\|ln\|ls\|mkdir\|mknod\|mv\|pwd\|rm\
\|rmdir\|stty\|sync\|true\|uname\),bin/\1,' \
	-e 's,usr/bin/\(chroot\),usr\/sbin/\1,'"

# As /usr may not be available during the early stages of booting,
# those binaries need to be on the root partition
var_append INSTALL_WRAPPER_FILTER "|" \
	"sed -e 's,usr/bin/\
\(cut\|head\|tail\|sleep\|sort\|touch\|readlink\),bin/\1,'"

hook_add postmake 5 'ln -sf install $root/usr/bin/ginstall'

# install hostname
var_append confopt ' ' '--enable-install-program=hostname'

noinstall=
for x in mktemp procps:uptime; do
	if pkginstalled "${x%:*}"; then
		var_append noinstall ',' "${x#*:}"
	fi
done
[ -z "$noinstall" ] ||
	var_append confopt ' ' "--enable-no-install-program=$noinstall"
