# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../musl/musl.conf
# Copyright (C) 2012 - 2014 The OpenSDE Project
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

# translate $arch for being usable with musl
musl_arch="$( echo $arch | arch2uname )"

if [ $prefix_auto == 1 ]; then
	syslibdir="/lib"
fi

if atstage toolchain; then
	confopt="--prefix=$base/build/$SDECFG_ID/usr \$extraconfopt"

	makeopt="ARCH=$musl_arch"
	var_append makeopt ' ' "include/bits"

	makeinstopt="ARCH=$musl_arch"
fi

musl_postinstall() {
	local LDSO=ld-musl-$musl_arch.so.1
	local LIBCSO=libc-musl-$musl_arch.so.1

	mv $root$libdir/libc.so $root$syslibdir/$LIBCSO
	ln -vsf $LIBCSO $root$syslibdir/$LDSO

	# create a libc.so symlink to avoid libtool's attempt linking shared
	# libs against libc.a in certain cases
	ln -vsf $( relative_path $root$syslibdir/$LIBCSO $root$libdir/libc.so ) \
		$root$libdir/libc.so

	# create a symlink from ld-musl-$musl_arch.so to ldd if the dynlinker
	# was started as "ldd" it will print DSO information
	ln -vsf $( relative_path $root$syslibdir/$LDSO $root$bindir/ldd ) \
		$root$bindir/ldd
}

# if musl is default libc
if [ "$SDECFG_LIBC" == "musl" ]; then
	# disable gcc wrapper script	
	var_append extraconfopt ' ' "--disable-gcc-wrapper"

	if ! atstage toolchain; then
		hook_add postinstall 5 'musl_postinstall'
	fi
fi

# always install the headers even if already present in the sandbox
hook_add postpatch 9 "touch include/*.h include/*/*.h"
var_append makeinstopt ' ' "install-headers"
