# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../fglrx/fglrx.conf
# Copyright (C) 2006 - 2012 The OpenSDE Project
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---


sysconfdir="/etc/ati"

custextract='fglrx_extract'
fglrx_extract() {
	sh $( match_source_file -p . ) --extract "$pkg"
	echo "$pkg" > untar.txt
}

commonsrc=common
case "$arch" in
	x86-64)	archsrc="arch/x86_64"
		xorgsrc="xpic_64a"
		atilib="lib64"
		;;
	*)	archsrc="arch/$arch"
		xorgsrc="xpic"
		atilib="lib"
		;;
esac

makeopt=
makeinstopt=


hook_add postmake 5 'fglrx_install'
fglrx_install() {
	local x11_bindir= x11_libdir= xorg_libdir=

	pkgprefix -t xorg-server
	x11_bindir=$root$( pkgprefix bindir xorg-server )
	x11_libdir=$root$( pkgprefix libdir xorg-server )
	xorg_libdir=$root$( pkgprefix libdir xorg-server )/xorg

	# arch
	#
	mv -vf $archsrc/usr/sbin/* $root$sbindir/
	mv -vf $archsrc/usr/X11R6/bin/* $x11_bindir/
	mv -vf $archsrc/usr/X11R6/$atilib/modules/dri/* $x11_libdir/dri/
	mv -vf $archsrc/usr/X11R6/$atilib/lib* $x11_libdir/

	# TODO: install during linux26
	# arch/x86/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4
	rm -rvf $archsrc/lib/modules/fglrx

	# X.org
	#
	mkdir -p $xorg_libdir/modules/{linux,drivers}
	mv -vf $xorgsrc/usr/X11R6/$atilib/modules/linux/libfglrxdrm.so $xorg_libdir/modules/linux/
	mv -vf $xorgsrc/usr/X11R6/$atilib/modules/drivers/fglrx_drv.so $xorg_libdir/modules/drivers/

	# common
	#
	mkdir -p $root$datadir/icons
	mkdir -p $root$mandir/man8
	mv -vf common/etc/ati/* $root$sysconfdir/
	mv -vf common/usr/include/GL/* $root$includedir/GL/
	mv -vf common/usr/share/icons/* $root$datadir/icons/
	mv -vf common/usr/share/man/man8/* $root$mandir/man8/
	mv -vf common/usr/sbin/* $root$sbindir/

	# TODO: install during linux26
	# common/lib/modules/fglrx <--- pkg_linux26_pre.conf
	rm -rvf common/lib/modules/fglrx

	# doc
	#
	( cd common/usr/share/doc/fglrx; tar -cf - * ) | tar -C $docdir -xvf -
	rm -rf common/usr/share/doc/fglrx
}

# list forgoten
hook_add postdoc 5 "find $xorgsrc $archsrc common ! -type d"

