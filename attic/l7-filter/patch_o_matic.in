# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: package/.../l7-filter/patch_o_matic.in
# Copyright (C) 2006 - 2009 The OpenSDE Project
# Copyright (C) 2004 - 2006 The T2 SDE Project
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

if l7patch="`match_source_file netfilter l7-filter`"; then
	l7ver=${l7patch%.tar.*}; l7ver=${l7ver#*layer7-}; l7ver=${l7ver#v}

	echo_status "Including l7-filter ($l7ver) patch ..."
	hook_add prepatch 5 "tar -C /tmp -v $taropt $base/download/mirror/n/$l7patch"
	hook_add prepatch 6 "l7_fix_and_inject_patch $l7patch"

	# removed on postinstall to be able to copy it to /usr/src/linux-patches
	hook_add postinstall 5 "rm -rf /tmp/${l7patch%.tar*}/"

	l7_fix_and_inject_patch() {
		local patchfile= patchfile2=
		local tmpdir="/tmp/${1%.tar*}" x=
		local l7_confdir=$(pkgdesc confdir l7-filter)

		# harmless for iptables
		var_append lx_confscripts ' ' $( echo $base/package/*/l7-filter/kernel.conf.sh )

		if [ "$pkg" = "iptables" ]; then
			x=$(echo $ver | cut -d. -f1-2)
			ls -al "$tmpdir/iptables-$x"-*
			patchfile=$(ls -1 "$tmpdir/iptables-$x"-*.patch | head -n1)
			hook_add postpatch 5 'chmod +x extensions/.layer7-test'

			# HACK - remove when a proper patch is included
			xt_l7_hack() {
				cp -av "$1"/* extensions/
				touch 'extensions/.layer7-test'
			}
			hook_add postpatch 4 "xt_l7_hack '$tmpdir/iptables-1.4.1.1-for-kernel-2.6.20forward'"
			return
		elif [[ $ver = 2.6* ]]; then
			x=$(echo "$ver" | cut -d. -f1-3)
			patchfile=$(ls -1 "$tmpdir/kernel"-2.6*.patch | head -n1)
			patchfile2="$l7_confdir/linux-$x.diff"
		fi

		if [ -s "$patchfile" ]; then
			var_append patchfiles ' ' "$patchfile"
		else
			abort "l7-filter: failed to detect patch."
		fi
		if [ -s "$patchfile2" ]; then
			var_append patchfiles ' ' "$patchfile2"
		fi
	}
else
	abort "what? l7-filter patch not found!"
fi
